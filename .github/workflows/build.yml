name: Build LeviLamina Plugin

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 0.1.0-alpha.1)'
        required: false
        default: 'manual'

jobs:
  # æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
  check:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Check build trigger
        id: check
        run: |
          # æ‰‹åŠ¨è§¦å‘æ—¶ç›´æ¥æ„å»º
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹åŠ¨è§¦å‘ï¼Œç‰ˆæœ¬: ${{ github.event.inputs.version }}"
          # Push æ—¶æ£€æŸ¥ commit message æ˜¯å¦åŒ…å« "build version"
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "ğŸ“ Commit message: $COMMIT_MSG"
            
            if [[ "$COMMIT_MSG" =~ build[[:space:]]+version[[:space:]]+([^[:space:]]+) ]]; then
              VERSION="${BASH_REMATCH[1]}"
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "âœ… æ£€æµ‹åˆ°æ„å»ºæŒ‡ä»¤ï¼Œç‰ˆæœ¬: $VERSION"
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "version=none" >> $GITHUB_OUTPUT
              echo "â­ï¸ è·³è¿‡æ„å»º (commit message ä¸­æœªæ‰¾åˆ° 'build version <ç‰ˆæœ¬å·>')"
            fi
          fi

  build:
    needs: check
    if: needs.check.outputs.should_build == 'true'
    runs-on: windows-latest
    
    steps:
      - name: ğŸš€ Show build info
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºç‰ˆæœ¬: ${{ needs.check.outputs.version }}"

      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest

      - name: ğŸ’¾ Cache xmake packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ runner.temp }}/.xmake/packages
            ~/AppData/Local/.xmake/packages
          key: ${{ runner.os }}-xmake-${{ hashFiles('xmake.lua') }}
          restore-keys: |
            ${{ runner.os }}-xmake-

      - name: ğŸ“¦ Update xmake repositories
        run: xmake repo -u

      - name: âš™ï¸ Configure
        run: xmake f -y -p windows -a x64 -m release

      - name: ğŸ”¨ Build
        run: xmake

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wooden-axe-${{ needs.check.outputs.version }}-windows-x64
          path: bin/wooden-axe/
